<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>TradeNote | ë‰´ìŠ¤</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="assets/app.js" defer></script>
    <script src="assets/market.js" defer></script>
</head>
<body>
    <header class="site-header">
        <a href="dashboard.html" class="brand" style="text-decoration: none; color: inherit;">
            <span class="brand-mark" aria-hidden="true">ğŸ“ˆ</span>
            <div>
                <p class="brand-name">TradeNote</p>
                <p class="brand-tagline">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</p>
            </div>
        </a>
        <div class="header-actions">
            <button class="theme-toggle" id="theme-toggle" type="button" aria-label="í…Œë§ˆ ë³€ê²½" title="ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜">
                <span class="theme-icon">âš™ï¸</span>
            </button>
        </div>
    </header>

    <nav class="side-nav" aria-label="ì£¼ìš” ì¹´í…Œê³ ë¦¬">
        <a href="dashboard.html" class="side-nav__item">ëŒ€ì‹œë³´ë“œ</a>
        <a href="index.html?view=journal" class="side-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="news.html" class="side-nav__item">ë‰´ìŠ¤</a>
    </nav>

    <main>
        <section id="news" class="content-section">
            <header class="section-header">
                <h2>ë‰´ìŠ¤ í”¼ë“œ</h2>
                <p>ì˜¤ëŠ˜ ì‹œì¥ì„ ì›€ì§ì¸ í•µì‹¬ í—¤ë“œë¼ì¸ì„ ë¹ ë¥´ê²Œ ëª¨ì•˜ìŠµë‹ˆë‹¤.</p>
            </header>
            <div class="news-tabs">
                <button class="news-tab active" data-news-type="korea">í•œêµ­ ë‰´ìŠ¤</button>
            </div>
            <div class="card-grid" id="news-list" aria-live="polite"></div>
        </section>
    </main>

    <nav class="bottom-nav" aria-label="í•˜ë‹¨ ì¹´í…Œê³ ë¦¬">
        <a href="index.html?view=journal" class="bottom-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="news.html" class="bottom-nav__item">ë‰´ìŠ¤</a>
    </nav>
</body>
<script>
// ë‰´ìŠ¤ íƒ­ ì „í™˜ ë° ë¡œë“œ
let currentNewsType = "korea";
let isLoadingNews = false;
let pendingLoadType = null;

const fetchNewsByType = async (type) => {
    try {
        // í”„ë¡œë•ì…˜ í™˜ê²½ ê°ì§€
        const isProduction = window.location.hostname === 'dongyeop-woo.github.io' || 
                             window.location.hostname.endsWith('.github.io') ||
                             window.location.hostname === 'weektalk.co.kr' ||
                             window.location.hostname === 'www.weektalk.co.kr';
        const API_BASE = isProduction 
            ? 'https://weektalk.co.kr'  // FastAPI (Nginxë¥¼ í†µí•´ /api/ ê²½ë¡œë¡œ ë¼ìš°íŒ…, HTTPS)
            : `http://${window.location.hostname}:8000`;
        const endpoint = "/api/news/korea";
        const response = await fetch(`${API_BASE}${endpoint}`);
        if (!response.ok) throw new Error("ë‰´ìŠ¤ API ì‹¤íŒ¨");
        const data = await response.json();
        return data.map((item) => {
            const headlineKo = item.headline_ko && item.headline_ko !== item.headline 
                ? item.headline_ko 
                : item.headline;
            const summaryKo = item.summary_ko && item.summary_ko !== item.summary 
                ? item.summary_ko 
                : (item.summary ?? "");
            
            return {
                title: headlineKo,
                summary: summaryKo,
                sentiment: "neutral",
                time: new Date(item.published_at).toLocaleString("ko-KR", { hour12: false }),
                url: item.url,
                source: item.source ?? "í•œêµ­ ë‰´ìŠ¤",
                originalTitle: item.headline,
                originalSummary: item.summary,
                image: item.image || null,
            };
        });
    } catch (error) {
        console.warn("ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨", error);
        return [];
    }
};

const loadNews = async (type) => {
    const newsList = document.getElementById("news-list");
    if (!newsList) return;
    
    // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ëŒ€ê¸°
    if (isLoadingNews) {
        pendingLoadType = type;
        return;
    }
    
    // íƒ€ì… ê²€ì¦
    if (type !== "korea") {
        console.warn("ì˜ëª»ëœ ë‰´ìŠ¤ íƒ€ì…:", type);
        return;
    }
    
    isLoadingNews = true;
    currentNewsType = type;
    
    newsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">ë¡œë”© ì¤‘...</div>';
    
    try {
        const items = await fetchNewsByType(type);
        
        // ìš”ì²­ì´ ì™„ë£Œëœ í›„ì—ë„ í˜„ì¬ ìš”ì²­í•œ íƒ€ì…ì´ ë§ëŠ”ì§€ í™•ì¸ (ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
        if (currentNewsType !== type) {
            console.log(`ë‰´ìŠ¤ íƒ€ì…ì´ ë³€ê²½ë˜ì–´ ì‘ë‹µ ë¬´ì‹œ (ìš”ì²­: ${type}, í˜„ì¬: ${currentNewsType})`);
            isLoadingNews = false;
            // ëŒ€ê¸° ì¤‘ì¸ ë¡œë“œê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
            if (pendingLoadType) {
                const nextType = pendingLoadType;
                pendingLoadType = null;
                await loadNews(nextType);
            }
            return;
        }
        
        if (typeof populateNews === "function") {
            populateNews(items);
        } else {
            newsList.innerHTML = items.length > 0 
                ? items.map(item => `
                    <article class="card">
                        ${item.image ? `<img src="${item.image}" alt="" class="news-image" loading="lazy">` : ''}
                        <h3>${item.title}</h3>
                        <p>${item.summary || ''}</p>
                        <footer>
                            <span>${item.source}</span>
                            <time>${item.time}</time>
                        </footer>
                        <a href="${item.url}" target="_blank" rel="noopener" class="card-link"></a>
                    </article>
                `).join('')
                : '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    } catch (error) {
        console.error("ë‰´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:", error);
        if (currentNewsType === type) {
            newsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    } finally {
        isLoadingNews = false;
        // ëŒ€ê¸° ì¤‘ì¸ ë¡œë“œê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
        if (pendingLoadType && currentNewsType === pendingLoadType) {
            const nextType = pendingLoadType;
            pendingLoadType = null;
            await loadNews(nextType);
        }
    }
};

document.addEventListener("DOMContentLoaded", async () => {
    // ë¨¼ì € ì´ˆê¸° ìƒíƒœ ëª…í™•íˆ ì„¤ì •
    currentNewsType = "korea";
    isLoadingNews = false;
    pendingLoadType = null;
    
    // app.jsê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    let retries = 0;
    while (typeof window.initAuth !== "function" && retries < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
    }
    
    // ì¸ì¦ ì´ˆê¸°í™”
    if (typeof window.initAuth === "function") {
        await window.initAuth();
    }
    
    const newsTabs = document.querySelectorAll(".news-tab");
    
    // ì´ˆê¸° ìƒíƒœ: í•œêµ­ ë‰´ìŠ¤ íƒ­ í™œì„±í™” (ëª…í™•íˆ ì„¤ì •)
    const koreaTab = document.querySelector('.news-tab[data-news-type="korea"]');
    if (koreaTab) koreaTab.classList.add("active");
    
    // ë‹¤ì‹œ í•œë²ˆ ëª…í™•íˆ ì„¤ì •
    currentNewsType = "korea";
    
    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸ (í•œêµ­ ë‰´ìŠ¤ë§Œ ìˆìœ¼ë¯€ë¡œ ì‹¤ì œë¡œëŠ” í•„ìš” ì—†ì§€ë§Œ ìœ ì§€)
    newsTabs.forEach(tab => {
        tab.addEventListener("click", async () => {
            const type = tab.getAttribute("data-news-type");
            if (!type || type !== "korea") return;
            if (type === currentNewsType && !isLoadingNews) return;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ë¨¼ì € ì—…ë°ì´íŠ¸
            newsTabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            
            // íƒ€ì… ë³€ê²½
            currentNewsType = type;
            
            // ë‰´ìŠ¤ ë¡œë“œ
            await loadNews(type);
        });
    });
    
    // ì´ˆê¸° ë¡œë“œ (í•œêµ­ ë‰´ìŠ¤ë§Œ) - ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
    await new Promise(resolve => setTimeout(resolve, 100));
    await loadNews("korea");
});
</script>
</html>


