<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>TradeNote | ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="assets/app.js" defer></script>
</head>
<body>
    <header class="site-header">
        <a href="index.html" class="brand" style="text-decoration: none; color: inherit;">
            <span class="brand-mark" aria-hidden="true">ğŸ“ˆ</span>
            <div>
                <p class="brand-name">TradeNote</p>
                <p class="brand-tagline">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</p>
            </div>
        </a>
        <div class="header-actions">
            <button class="theme-toggle" id="theme-toggle" type="button" aria-label="í…Œë§ˆ ë³€ê²½" title="ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜">
                <span class="theme-icon">âš™ï¸</span>
            </button>
        </div>
    </header>

    <nav class="side-nav" aria-label="ì£¼ìš” ì¹´í…Œê³ ë¦¬">
        <a href="index.html" class="side-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="news.html" class="side-nav__item">ë‰´ìŠ¤</a>
        <a href="community.html" class="side-nav__item">ì»¤ë®¤ë‹ˆí‹°</a>
        <a href="ai-analysis.html" class="side-nav__item">AI ë¶„ì„</a>
        <a href="calendar.html" class="side-nav__item">ìº˜ë¦°ë”</a>
        <a href="me.html" class="side-nav__item">ë‚´ì •ë³´</a>
    </nav>

    <main>
        <section id="community" class="content-section" aria-label="ì»¤ë®¤ë‹ˆí‹°">
            <header class="section-header">
                <h2>ì»¤ë®¤ë‹ˆí‹°</h2>
            </header>
            <nav class="sub-tabs" role="tablist" aria-label="ì»¤ë®¤ë‹ˆí‹° íƒ­">
                <a href="#" class="sub-tab active" role="tab" aria-selected="true" data-target="community-free">ììœ ê²Œì‹œíŒ</a>
                <a href="#" class="sub-tab" role="tab" aria-selected="false" data-target="community-hot">í•«ì´ìŠˆ</a>
                <a href="#" class="sub-tab" role="tab" aria-selected="false" data-target="community-notice">ê³µì§€ì‚¬í•­</a>
            </nav>
            <div id="community-free" class="sub-tab-panel active" role="tabpanel" aria-labelledby="ììœ ê²Œì‹œíŒ">
                <div id="free-list" class="trading-list-scroll"></div>
            </div>
            <div id="community-hot" class="sub-tab-panel" role="tabpanel" aria-labelledby="í•«ì´ìŠˆ" hidden>
                <div id="hot-list" class="trading-list-scroll"></div>
            </div>
            <div id="community-notice" class="sub-tab-panel" role="tabpanel" aria-labelledby="ê³µì§€ì‚¬í•­" hidden>
                <div id="notice-list" class="trading-list-scroll">
                    <article class="card notice-card">
                        <h3 style="margin:0 0 0.75rem;font-size:1.1rem;font-weight:600;">ì•ˆë…•í•˜ì„¸ìš” TradeNoteì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤.</h3>
                        <p style="margin:0;white-space:pre-wrap;line-height:1.6;">TradeNoteì—ì„œ ë§¤ë§¤ì¼ì§€ì™€ AI ë¶„ì„ì„ í†µí•´ ìŠ¹ë¥ ì„ ì˜¬ë ¤ë³´ì„¸ìš”.
ê±´ì˜ì‚¬í•­ì€ dongyeopwoo1@gmail.comë¡œ ì—°ë½ë°”ëë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                    </article>
                </div>
            </div>
            <!-- ë¡œê·¸ì¸ í•„ìš” ì˜¤ë²„ë ˆì´ (ë¡œê·¸ì¸ ì•ˆ í•˜ë©´ í‘œì‹œ) -->
            <div class="login-block-overlay" id="login-overlay" aria-hidden="true">
                <div class="login-block-content" role="dialog" aria-labelledby="login-block-title" aria-describedby="login-block-desc">
                    <h3 id="login-block-title">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
                    <p id="login-block-desc">ì»¤ë®¤ë‹ˆí‹°ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                    <a href="login.html" class="login-block-button" aria-label="ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </section>
    </main>
    <!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ (í•„ìˆ˜) -->
    <div class="side-modal-overlay" id="modal-overlay"></div>
    <!-- ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° FAB -->
    <button id="fab-compose" class="fab" type="button" aria-label="ìƒˆ ê¸€ ì“°ê¸°" data-modal="community-compose-modal">+</button>

    <!-- ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° ì‚¬ì´ë“œ ëª¨ë‹¬ -->
    <div class="side-modal" id="community-compose-modal" aria-labelledby="compose-title" aria-modal="true" role="dialog">
        <div class="side-modal-header">
            <h2 id="compose-title">ê²Œì‹œê¸€ ì‘ì„±</h2>
            <button type="button" class="side-modal-close" data-modal="community-compose-modal" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div class="side-modal-body">
            <form class="trading-form" id="community-compose-form">
                <div class="form-row">
                    <div class="form-field form-field-full">
                        <label for="compose-category">ì¹´í…Œê³ ë¦¬</label>
                        <select id="compose-category" required>
                            <option value="free">ììœ ê²Œì‹œíŒ</option>
                            <option value="hot">í•«ì´ìŠˆ</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="compose-stock">ì£¼ì‹ëª…</label>
                        <input type="text" id="compose-stock" placeholder="ì˜ˆ: AAPL" />
                    </div>
                    <div class="form-field form-field-full">
                        <label for="compose-title-input">ì œëª©</label>
                        <input type="text" id="compose-title-input" placeholder="ì œëª© ì…ë ¥ë€" required />
                    </div>
                    <div class="form-field form-field-full">
                        <label for="compose-content">ë‚´ìš©</label>
                        <textarea id="compose-content" placeholder="ë‚´ìš© ì…ë ¥ë€" rows="8" required></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="cta-button">ê¸€ì“°ê¸°</button>
                    <button type="button" class="cancel-btn" data-modal="community-compose-modal">ì·¨ì†Œ</button>
                </div>
            </form>
</div>
    </div>
    <!-- ê¸€ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="side-modal" id="community-detail-modal" aria-modal="true" role="dialog">
        <div class="side-modal-header">
            <h2 id="detail-title">ê²Œì‹œê¸€</h2>
            <button type="button" class="side-modal-close" data-modal="community-detail-modal" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
        <div class="side-modal-body">
            <article class="card" id="detail-body" style="margin-bottom:1rem;"></article>
            <section class="card">
                <h3 style="margin-top:0;">ëŒ“ê¸€</h3>
                <div id="detail-comments" class="trading-list-scroll" style="max-height:220px;"></div>
                <form id="comment-form" style="margin-top:0.75rem;">
                    <div class="form-field form-field-full" style="position: relative;">
                        <label for="comment-input">ëŒ“ê¸€ ì‘ì„±</label>
                        <textarea id="comment-input" rows="3" placeholder="ë‚´ìš© ì…ë ¥ (ì˜ˆ: @ì‘ì„±ìëª…)" required></textarea>
                        <div id="mention-dropdown" class="mention-dropdown" style="display: none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="cta-button">ë“±ë¡</button>
                        <button type="button" class="cancel-btn" data-modal="community-detail-modal">ë‹«ê¸°</button>
                    </div>
                </form>
            </section>
        </div>
    </div>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // app.jsê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    let retries = 0;
    while (typeof window.initAuth !== "function" && retries < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
    }
    
    // ì¸ì¦ ì´ˆê¸°í™”
    if (typeof window.initAuth === "function") {
        await window.initAuth();
    }
    
    const tabs = document.querySelectorAll(".sub-tab");
    const panels = document.querySelectorAll(".sub-tab-panel");
    tabs.forEach(tab => {
        tab.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = tab.getAttribute("data-target");
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            panels.forEach(p => {
                const isActive = p.id === targetId;
                p.classList.toggle("active", isActive);
                p.hidden = !isActive;
            });
        });
    });
    // FAB í´ë¦­: ë¡œê·¸ì¸ ê°€ë“œ í›„ ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
    const fab = document.getElementById("fab-compose");
    if (fab) {
        fab.addEventListener("click", () => {
            if (typeof guardTradingAccess === "function" && !guardTradingAccess()) return;
            const modalId = fab.getAttribute("data-modal");
            if (typeof openSideModal === "function" && modalId) {
                openSideModal(modalId);
            }
        });
    }
    // ì‘ì„± í¼ ì œì¶œ(ì„ì‹œ): ìœ íš¨ì„± ê²€ì‚¬ í›„ ë‹«ê¸°
    const form = document.getElementById("community-compose-form");
    if (form) {
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            if (typeof guardTradingAccess === "function" && !guardTradingAccess()) return;
            const category = document.getElementById("compose-category").value;
            const stock = document.getElementById("compose-stock").value.trim();
            const title = document.getElementById("compose-title-input").value.trim();
            const content = document.getElementById("compose-content").value.trim();
            if (!title || !content) {
                alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const submitBtn = form.querySelector(".cta-button");
            if (submitBtn) submitBtn.disabled = true;
            // API ì—°ê²°
            if (typeof requestJSON === "function") {
                requestJSON(`${AUTH_API_BASE}/api/community/posts`, {
                    method: "POST",
                    body: JSON.stringify({ category, stock, title, content })
                })
                .then((post) => {
                    alert("ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    const item = {
                        id: post?.id,
                        category,
                        stock,
                        title,
                        authorNickname: (authState?.user?.displayName) || "ë‚˜",
                        createdAt: new Date().toISOString(),
                        commentCount: 0
                    };
                    prependPostToList(category, item);
                    form.reset();
                    if (typeof closeSideModal === "function") {
                        closeSideModal("community-compose-modal");
                    }
                })
                .catch((err) => {
                    alert(err?.message || "ê²Œì‹œê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                })
                .finally(() => {
                    if (submitBtn) submitBtn.disabled = false;
                });
            } else {
                alert("ìš”ì²­ í•¨ìˆ˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
    // ì´ˆê¸° ëª©ë¡ ë¡œë“œ
    refreshList("free");
    refreshList("hot");

    function refreshList(category) {
        fetch(`${AUTH_API_BASE}/api/community/posts?category=${encodeURIComponent(category)}&page=0&size=20`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                const items = data?.content || [];
                renderList(category, items);
            })
            .catch(() => {
                renderList(category, []);
            });
    }

    function renderList(category, items) {
        const containerId = category === "hot" ? "hot-list" : "free-list";
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = "";
        
        // ê³µì§€ì‚¬í•­ ì¹´ë“œ ì¶”ê°€ (ëª¨ë“  íƒ­ì— í‘œì‹œ)
        const noticeCard = document.createElement("article");
        noticeCard.className = "card notice-card";
        noticeCard.innerHTML = `
            <h3 style="margin:0 0 0.75rem;font-size:1.1rem;font-weight:600;">ì•ˆë…•í•˜ì„¸ìš” TradeNoteì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤.</h3>
            <p style="margin:0;white-space:pre-wrap;line-height:1.6;">TradeNoteì—ì„œ ë§¤ë§¤ì¼ì§€ì™€ AI ë¶„ì„ì„ í†µí•´ ìŠ¹ë¥ ì„ ì˜¬ë ¤ë³´ì„¸ìš”.
ê±´ì˜ì‚¬í•­ì€ dongyeopwoo1@gmail.comë¡œ ì—°ë½ë°”ëë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.</p>
        `;
        container.appendChild(noticeCard);
        
        if (!items.length) {
            const empty = document.createElement("div");
            empty.className = "empty-trading-list";
            empty.textContent = "ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
            container.appendChild(empty);
            return;
        }
        items.forEach(post => {
            container.appendChild(renderPostCard(post));
        });
    }

    function renderPostCard(post) {
        const card = document.createElement("article");
        card.className = "card post-card-clickable";
        card.style.cursor = "pointer";
        const meta = new Date(post.createdAt || Date.now()).toLocaleString("ko-KR", { hour12: false });
        const postId = post.id;
        card.innerHTML = `
            <header style="display:flex;justify-content:space-between;align-items:center;">
                <strong>${escapeHtml(post.title)}</strong>
                <span class="badge">${post.commentCount ?? 0} ëŒ“ê¸€</span>
            </header>
            <p style="margin:0.25rem 0 0.5rem;color:var(--text-muted);">
                ${escapeHtml(post.authorNickname || "-")} Â· ${meta} ${post.stock ? `Â· ${escapeHtml(post.stock)}` : ""}
            </p>
            <div class="vote-row" data-id="${postId}" data-stop-propagation>
                <button type="button" class="vote-btn ${post.userVote === 'up' ? 'vote-btn-active' : ''}" data-type="up" ${post.userVote === 'up' ? 'disabled' : ''}>ì¶”ì²œ â–² <span class="vote-count" data-role="up">${post.upVotes ?? 0}</span></button>
                <button type="button" class="vote-btn ${post.userVote === 'down' ? 'vote-btn-active' : ''}" data-type="down" ${post.userVote === 'down' ? 'disabled' : ''}>ë¹„ì¶”ì²œ â–¼ <span class="vote-count" data-role="down">${post.downVotes ?? 0}</span></button>
            </div>
        `;
        
        // ì¹´ë“œ ì „ì²´ í´ë¦­ ì‹œ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        card.addEventListener("click", (ev) => {
            // vote-rowë‚˜ ê·¸ ìì‹ ìš”ì†Œë¥¼ í´ë¦­í•œ ê²½ìš°ëŠ” ìƒì„¸ ëª¨ë‹¬ì„ ì—´ì§€ ì•ŠìŒ
            if (ev.target.closest(".vote-row")) {
                return;
            }
            openDetail(postId);
        });
        
        // íˆ¬í‘œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        const votes = card.querySelector(".vote-row");
        if (votes) {
            votes.addEventListener("click", (ev) => {
                ev.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                const target = ev.target;
                if (!(target instanceof HTMLElement)) return;
                if (target.classList.contains("vote-btn") && target.dataset.type && !target.disabled) {
                    const type = target.dataset.type;
                    requestJSON(`${AUTH_API_BASE}/api/community/posts/${postId}/vote?type=${encodeURIComponent(type)}`, {
                        method: "POST"
                    })
                    .then((res) => {
                        const upBtn = votes.querySelector('.vote-btn[data-type="up"]');
                        const downBtn = votes.querySelector('.vote-btn[data-type="down"]');
                        const upEl = votes.querySelector('.vote-btn[data-type="up"] .vote-count[data-role="up"]');
                        const downEl = votes.querySelector('.vote-btn[data-type="down"] .vote-count[data-role="down"]');
                        if (upEl) upEl.textContent = String(res.upVotes ?? 0);
                        if (downEl) downEl.textContent = String(res.downVotes ?? 0);
                        
                        // íˆ¬í‘œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê°™ì€ íˆ¬í‘œë©´ ë¹„í™œì„±í™”, ë‹¤ë¥¸ íˆ¬í‘œë©´ í™œì„±í™”)
                        if (res.userVote === 'up') {
                            if (upBtn) { 
                                upBtn.classList.add('vote-btn-active'); 
                                upBtn.disabled = true; 
                            }
                            if (downBtn) { 
                                downBtn.classList.remove('vote-btn-active'); 
                                downBtn.disabled = false; 
                            }
                        } else if (res.userVote === 'down') {
                            if (downBtn) { 
                                downBtn.classList.add('vote-btn-active'); 
                                downBtn.disabled = true; 
                            }
                            if (upBtn) { 
                                upBtn.classList.remove('vote-btn-active'); 
                                upBtn.disabled = false; 
                            }
                        } else {
                            // íˆ¬í‘œ ì·¨ì†Œëœ ê²½ìš°
                            if (upBtn) { upBtn.classList.remove('vote-btn-active'); upBtn.disabled = false; }
                            if (downBtn) { downBtn.classList.remove('vote-btn-active'); downBtn.disabled = false; }
                        }
                    })
                    .catch((err) => {
                        const msg = err?.message || "íˆ¬í‘œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        if (msg.includes("ì´ë¯¸ íˆ¬í‘œ")) {
                            alert("ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íˆ¬í‘œë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                        } else {
                            alert(msg);
                        }
                    });
                }
            });
        }
        return card;
    }

    function prependPostToList(category, post) {
        const containerId = category === "hot" ? "hot-list" : "free-list";
        const container = document.getElementById(containerId);
        if (!container) return;
        const empty = container.querySelector(".empty-trading-list");
        if (empty) empty.remove();
        
        // ê³µì§€ì‚¬í•­ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        let noticeCard = container.querySelector(".notice-card");
        if (!noticeCard) {
            noticeCard = document.createElement("article");
            noticeCard.className = "card notice-card";
            noticeCard.innerHTML = `
                <h3 style="margin:0 0 0.75rem;font-size:1.1rem;font-weight:600;">ì•ˆë…•í•˜ì„¸ìš” TradeNoteì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤.</h3>
                <p style="margin:0;white-space:pre-wrap;line-height:1.6;">TradeNoteì—ì„œ ë§¤ë§¤ì¼ì§€ì™€ AI ë¶„ì„ì„ í†µí•´ ìŠ¹ë¥ ì„ ì˜¬ë ¤ë³´ì„¸ìš”.
ê±´ì˜ì‚¬í•­ì€ dongyeopwoo1@gmail.comë¡œ ì—°ë½ë°”ëë‹ˆë‹¤.
ê°ì‚¬í•©ë‹ˆë‹¤.</p>
            `;
            container.insertBefore(noticeCard, container.firstChild);
        }
        
        // ê³µì§€ì‚¬í•­ ë‹¤ìŒì— ìƒˆ ê²Œì‹œê¸€ ì¶”ê°€
        const postCard = renderPostCard(post);
        if (noticeCard.nextSibling) {
            container.insertBefore(postCard, noticeCard.nextSibling);
        } else {
            container.appendChild(postCard);
        }
    }

    function openDetail(postId) {
        fetch(`${AUTH_API_BASE}/api/community/posts/${postId}`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                const titleEl = document.getElementById("detail-title");
                const bodyEl = document.getElementById("detail-body");
                const commentsEl = document.getElementById("detail-comments");
                if (titleEl) titleEl.textContent = data.title || "ê²Œì‹œê¸€";
                if (bodyEl) {
                    bodyEl.innerHTML = `
                        <p style="margin:0 0 0.5rem;color:var(--text-muted);">
                            ${escapeHtml(data.authorNickname || "-")} Â· ${new Date(data.createdAt || Date.now()).toLocaleString("ko-KR", { hour12:false })} ${data.stock ? `Â· ${escapeHtml(data.stock)}` : ""}
                        </p>
                        <h3 style="margin:0.25rem 0 0.75rem;">${escapeHtml(data.title || "")}</h3>
                        <p style="white-space:pre-wrap;">${escapeHtml(data.content || "")}</p>
                    `;
                }
                if (commentsEl) {
                    commentsEl.innerHTML = "";
                    const list = data.comments || [];
                    if (!list.length) {
                        const empty = document.createElement("div");
                        empty.className = "empty-trading-list";
                        empty.textContent = "ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
                        commentsEl.appendChild(empty);
                    } else {
                        // í˜„ì¬ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (authState.user.id ë˜ëŠ” usernameìœ¼ë¡œ ë¹„êµ)
                        const currentUserId = (authState?.user?.id) || null;
                        const currentUsername = (authState?.user?.username) || (authState?.user?.displayName) || null;
                        list.forEach(c => {
                            const isEdited = c.updatedAt && new Date(c.updatedAt).getTime() > new Date(c.createdAt).getTime() + 1000;
                            // ì‘ì„±ì ID ë˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë¹„êµ
                            const isMyComment = (currentUserId && c.authorId && c.authorId === currentUserId) || 
                                                (currentUsername && c.authorNickname && c.authorNickname === currentUsername);
                            const item = document.createElement("div");
                            item.className = "comment-item";
                            item.innerHTML = `
                                <div class="comment-content">
                                    <span class="comment-author">${escapeHtml(c.authorNickname)}</span>
                                    <span class="comment-text">${formatCommentWithMentions(c.content)}</span>
                                    ${isEdited ? '<span class="comment-edited">(ìˆ˜ì •ë¨)</span>' : ''}
                                    <span class="comment-date">${new Date(c.createdAt).toLocaleString("ko-KR", { hour12:false, month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                                <div class="comment-actions-row">
                                    <div class="comment-vote-row" data-comment-id="${c.id}">
                                        <button type="button" class="vote-btn vote-btn-small ${c.userVote === 'up' ? 'vote-btn-active' : ''}" data-type="up" ${c.userVote === 'up' ? 'disabled' : ''}>â–² <span class="vote-count" data-role="up">${c.upVotes ?? 0}</span></button>
                                        <button type="button" class="vote-btn vote-btn-small ${c.userVote === 'down' ? 'vote-btn-active' : ''}" data-type="down" ${c.userVote === 'down' ? 'disabled' : ''}>â–¼ <span class="vote-count" data-role="down">${c.downVotes ?? 0}</span></button>
                                    </div>
                                    ${isMyComment ? `
                                        <div class="comment-edit-actions">
                                            <button type="button" class="comment-edit-btn" data-comment-id="${c.id}" data-comment-content="${escapeHtml(c.content)}">ìˆ˜ì •</button>
                                            <button type="button" class="comment-delete-btn" data-comment-id="${c.id}">ì‚­ì œ</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                            const voteRow = item.querySelector(".comment-vote-row");
                            if (voteRow) {
                                voteRow.addEventListener("click", (e) => {
                                    const t = e.target;
                                    if (!(t instanceof HTMLElement)) return;
                                    if (t.classList.contains("vote-btn") && t.dataset.type && !t.disabled) {
                                        const type = t.dataset.type;
                                        const cid = voteRow.getAttribute("data-comment-id");
                                        requestJSON(`${AUTH_API_BASE}/api/community/comments/${cid}/vote?type=${encodeURIComponent(type)}`, {
                                            method: "POST"
                                        }).then(() => {
                                            // ê°„ë‹¨íˆ ì¦ê°€ ë°˜ì˜: ìƒì„¸ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì •í™•íˆ ë°˜ì˜
                                            openDetail(postId);
                                        }).catch((err) => {
                                            const msg = err?.message || "íˆ¬í‘œ ì‹¤íŒ¨";
                                            if (msg.includes("ì´ë¯¸ íˆ¬í‘œ")) {
                                                alert("ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íˆ¬í‘œë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                                            } else {
                                                alert(msg);
                                            }
                                        });
                                    }
                                });
                            }
                            
                            // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
                            const editBtn = item.querySelector(".comment-edit-btn");
                            if (editBtn) {
                                editBtn.addEventListener("click", (e) => {
                                    e.stopPropagation();
                                    const commentId = editBtn.getAttribute("data-comment-id");
                                    const currentContent = editBtn.getAttribute("data-comment-content");
                                    openCommentEditModal(commentId, currentContent, postId);
                                });
                            }
                            
                            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                            const deleteBtn = item.querySelector(".comment-delete-btn");
                            if (deleteBtn) {
                                deleteBtn.addEventListener("click", (e) => {
                                    e.stopPropagation();
                                    if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                                    const commentId = deleteBtn.getAttribute("data-comment-id");
                                    requestJSON(`${AUTH_API_BASE}/api/community/comments/${commentId}`, {
                                        method: "DELETE"
                                    }).then(() => {
                                        openDetail(postId);
                                    }).catch(err => alert(err?.message || "ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
                                });
                            }
                            
                            commentsEl.appendChild(item);
                        });
                    }
                }
                const form = document.getElementById("comment-form");
                const commentInput = document.getElementById("comment-input");
                const mentionDropdown = document.getElementById("mention-dropdown");
                let availableAuthors = [];
                
                // ëŒ“ê¸€ ì‘ì„±ì ëª©ë¡ ìˆ˜ì§‘
                if (data.comments && data.comments.length > 0) {
                    availableAuthors = [...new Set(data.comments.map(c => c.authorNickname).filter(Boolean))];
                    // ê²Œì‹œê¸€ ì‘ì„±ìë„ ì¶”ê°€
                    if (data.authorNickname) {
                        availableAuthors.push(data.authorNickname);
                    }
                    availableAuthors = [...new Set(availableAuthors)];
                } else if (data.authorNickname) {
                    availableAuthors = [data.authorNickname];
                }
                
                if (form && commentInput) {
                    // @ ì…ë ¥ ê°ì§€ ë° ìë™ì™„ì„±
                    commentInput.addEventListener("input", (e) => {
                        const text = e.target.value;
                        const cursorPos = e.target.selectionStart;
                        const textBeforeCursor = text.substring(0, cursorPos);
                        const lastAtIndex = textBeforeCursor.lastIndexOf("@");
                        
                        if (lastAtIndex !== -1) {
                            const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
                            // ê³µë°±ì´ë‚˜ ì¤„ë°”ê¿ˆì´ ì—†ìœ¼ë©´ ë©˜ì…˜ ê²€ìƒ‰
                            if (!textAfterAt.match(/[\s\n]/)) {
                                const searchTerm = textAfterAt.toLowerCase();
                                const matches = availableAuthors.filter(author => 
                                    author.toLowerCase().startsWith(searchTerm)
                                );
                                
                                if (matches.length > 0) {
                                    showMentionDropdown(matches, lastAtIndex, commentInput, mentionDropdown);
                                } else {
                                    hideMentionDropdown(mentionDropdown);
                                }
                            } else {
                                hideMentionDropdown(mentionDropdown);
                            }
                        } else {
                            hideMentionDropdown(mentionDropdown);
                        }
                    });
                    
                    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (Enterë¡œ ì„ íƒ, Escapeë¡œ ë‹«ê¸°)
                    commentInput.addEventListener("keydown", (e) => {
                        if (mentionDropdown.style.display !== "none") {
                            const selected = mentionDropdown.querySelector(".mention-item.selected");
                            const items = mentionDropdown.querySelectorAll(".mention-item");
                            
                            if (e.key === "ArrowDown") {
                                e.preventDefault();
                                if (selected) {
                                    selected.classList.remove("selected");
                                    const next = selected.nextElementSibling || items[0];
                                    if (next) next.classList.add("selected");
                                } else if (items[0]) {
                                    items[0].classList.add("selected");
                                }
                            } else if (e.key === "ArrowUp") {
                                e.preventDefault();
                                if (selected) {
                                    selected.classList.remove("selected");
                                    const prev = selected.previousElementSibling || items[items.length - 1];
                                    if (prev) prev.classList.add("selected");
                                } else if (items[items.length - 1]) {
                                    items[items.length - 1].classList.add("selected");
                                }
                            } else if (e.key === "Enter" && selected) {
                                e.preventDefault();
                                selected.click();
                            } else if (e.key === "Escape") {
                                hideMentionDropdown(mentionDropdown);
                            }
                        }
                    });
                    
                    form.onsubmit = (ev) => {
                        ev.preventDefault();
                        if (typeof guardTradingAccess === "function" && !guardTradingAccess()) return;
                        const text = (commentInput?.value || "").trim();
                        if (!text) return;
                        const btn = form.querySelector(".cta-button");
                        if (btn) btn.disabled = true;
                        hideMentionDropdown(mentionDropdown);
                        requestJSON(`${AUTH_API_BASE}/api/community/posts/${postId}/comments`, {
                            method: "POST",
                            body: JSON.stringify({ content: text })
                        })
                        .then(() => {
                            commentInput.value = "";
                            openDetail(postId);
                        })
                        .catch(err => alert(err?.message || "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨"))
                        .finally(() => { if (btn) btn.disabled = false; });
                    };
                }
                if (typeof openSideModal === "function") openSideModal("community-detail-modal");
            })
            .catch(() => alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
    }

    function escapeHtml(str) {
        return String(str ?? "").replace(/[&<>\\\"]/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;" }[s]));
    }
    
    function formatCommentWithMentions(content) {
        if (!content) return "";
        // @ì‘ì„±ìëª… í˜•ì‹ì„ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸ (í•œê¸€, ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ ì§€ì›)
        const escaped = escapeHtml(content);
        return escaped.replace(/@([\wê°€-í£]+)/g, '<span class="mention-tag">@$1</span>');
    }
    
    function openCommentEditModal(commentId, currentContent, postId) {
        const newContent = prompt("ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:", currentContent);
        if (newContent === null || newContent.trim() === currentContent.trim()) return;
        if (!newContent.trim()) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        requestJSON(`${AUTH_API_BASE}/api/community/comments/${commentId}`, {
            method: "PUT",
            body: JSON.stringify({ content: newContent.trim() })
        }).then(() => {
            openDetail(postId);
        }).catch(err => alert(err?.message || "ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }
    
    function showMentionDropdown(matches, atIndex, textarea, dropdown) {
        dropdown.innerHTML = matches.map((author, idx) => 
            `<div class="mention-item ${idx === 0 ? 'selected' : ''}" data-author="${escapeHtml(author)}">@${escapeHtml(author)}</div>`
        ).join("");
        dropdown.style.display = "block";
        
        // í´ë¦­ ì´ë²¤íŠ¸
        dropdown.querySelectorAll(".mention-item").forEach(item => {
            item.addEventListener("click", () => {
                const author = item.getAttribute("data-author");
                const text = textarea.value;
                const cursorPos = textarea.selectionStart;
                const textBeforeCursor = text.substring(0, cursorPos);
                const lastAtIndex = textBeforeCursor.lastIndexOf("@");
                const textAfterCursor = text.substring(cursorPos);
                
                const newText = text.substring(0, lastAtIndex) + `@${author} ` + textAfterCursor;
                textarea.value = newText;
                const newCursorPos = lastAtIndex + author.length + 2;
                textarea.setSelectionRange(newCursorPos, newCursorPos);
                textarea.focus();
                hideMentionDropdown(dropdown);
            });
        });
    }
    
    function hideMentionDropdown(dropdown) {
        if (dropdown) {
            dropdown.style.display = "none";
            dropdown.innerHTML = "";
        }
    }
});
</script>

    <nav class="bottom-nav" aria-label="í•˜ë‹¨ ì¹´í…Œê³ ë¦¬">
        <a href="index.html" class="bottom-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="news.html" class="bottom-nav__item">ë‰´ìŠ¤</a>
        <a href="community.html" class="bottom-nav__item">ì»¤ë®¤ë‹ˆí‹°</a>
        <a href="ai-analysis.html" class="bottom-nav__item">AI ë¶„ì„</a>
        <a href="calendar.html" class="bottom-nav__item">ìº˜ë¦°ë”</a>
        <a href="me.html" class="bottom-nav__item">ë‚´ì •ë³´</a>
    </nav>
</body>
</html>


