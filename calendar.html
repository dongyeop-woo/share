<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>TradeNote | ìº˜ë¦°ë”</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="assets/app.js" defer></script>
</head>
<body>
    <header class="site-header">
        <a href="dashboard.html" class="brand" style="text-decoration: none; color: inherit;">
            <span class="brand-mark" aria-hidden="true">ğŸ“ˆ</span>
            <div>
                <p class="brand-name">TradeNote</p>
                <p class="brand-tagline">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</p>
            </div>
        </a>
        <div class="header-actions">
            <button class="theme-toggle" id="theme-toggle" type="button" aria-label="í…Œë§ˆ ë³€ê²½" title="ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜">
                <span class="theme-icon">âš™ï¸</span>
            </button>
        </div>
    </header>

    <nav class="side-nav" aria-label="ì£¼ìš” ì¹´í…Œê³ ë¦¬">
        <a href="dashboard.html" class="side-nav__item">ëŒ€ì‹œë³´ë“œ</a>
        <a href="index.html?view=journal" class="side-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="calendar.html" class="side-nav__item">ìº˜ë¦°ë”</a>
    </nav>

    <main>
        <section id="calendar" class="content-section" aria-label="ìº˜ë¦°ë”">
            <header class="section-header">
                <h2>ìº˜ë¦°ë”</h2>
            </header>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button type="button" class="calendar-nav-btn" id="prev-month">â€¹</button>
                    <h3 id="calendar-month-year"></h3>
                    <button type="button" class="calendar-nav-btn" id="next-month">â€º</button>
                </div>
                <div class="calendar-weekdays">
                    <div class="calendar-weekday">ì¼</div>
                    <div class="calendar-weekday">ì›”</div>
                    <div class="calendar-weekday">í™”</div>
                    <div class="calendar-weekday">ìˆ˜</div>
                    <div class="calendar-weekday">ëª©</div>
                    <div class="calendar-weekday">ê¸ˆ</div>
                    <div class="calendar-weekday">í† </div>
                </div>
                <div class="calendar-days" id="calendar-days"></div>
            </div>
            <!-- ë‚ ì§œ ìƒì„¸ ëª¨ë‹¬ -->
            <div class="side-modal-overlay" id="calendar-detail-modal">
                <div class="side-modal">
                    <div class="side-modal-header">
                        <h3 id="calendar-detail-date"></h3>
                        <button type="button" class="side-modal-close" id="close-calendar-detail">&times;</button>
                    </div>
                    <div class="side-modal-body" id="calendar-detail-content">
                        <!-- ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <nav class="bottom-nav" aria-label="í•˜ë‹¨ ì¹´í…Œê³ ë¦¬">
        <a href="index.html?view=journal" class="bottom-nav__item">ë§¤ë§¤ì¼ì§€</a>
        <a href="calendar.html" class="bottom-nav__item">ìº˜ë¦°ë”</a>
    </nav>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    // app.jsê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    let retries = 0;
    while (typeof window.initAuth !== "function" && retries < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
    }
    
    // ì¸ì¦ ì´ˆê¸°í™”
    if (typeof window.initAuth === "function") {
        await window.initAuth();
    }
    
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();

    // ë§¤ë§¤ ë‚´ì—­ì„ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
    function getTradingByDate() {
        const history = typeof loadTradingHistory === "function" ? loadTradingHistory() : [];
        const tradingByDate = {};
        
        history.forEach(record => {
            const dateStr = record.date;
            if (!tradingByDate[dateStr]) {
                tradingByDate[dateStr] = [];
            }
            tradingByDate[dateStr].push(record);
        });
        
        return tradingByDate;
    }

    // ìº˜ë¦°ë” ë Œë”ë§
    function renderCalendar() {
        const calendarDays = document.getElementById("calendar-days");
        const monthYear = document.getElementById("calendar-month-year");
        if (!calendarDays || !monthYear) return;

        const tradingByDate = getTradingByDate();
        
        // ì›”/ë…„ í‘œì‹œ
        const monthNames = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];
        monthYear.textContent = `${currentYear}ë…„ ${monthNames[currentMonth]}`;

        // ì²« ë²ˆì§¸ ë‚ ì§œì™€ ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay()); // ì£¼ì˜ ì²« ë‚ 

        calendarDays.innerHTML = "";

        // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 6ì£¼ì¹˜ ë‚ ì§œ ë Œë”ë§
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement("div");
            dayElement.className = "calendar-day";
            
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.toDateString() === new Date().toDateString();
            const dateStr = getLocalDateString(date);
            const trades = tradingByDate[dateStr] || [];
            
            if (!isCurrentMonth) {
                dayElement.classList.add("calendar-day-other-month");
            }
            if (isToday) {
                dayElement.classList.add("calendar-day-today");
            }
            if (trades.length > 0) {
                dayElement.classList.add("calendar-day-has-trade");
            }

            const dayNumber = document.createElement("div");
            dayNumber.className = "calendar-day-number";
            dayNumber.textContent = date.getDate();
            dayElement.appendChild(dayNumber);

            // ë§¤ë§¤ ë‚´ì—­ í‘œì‹œ
            if (trades.length > 0) {
                const tradeIndicator = document.createElement("div");
                tradeIndicator.className = "calendar-day-trades";
                const uniqueStocks = [...new Set(trades.map(t => t.stock).filter(Boolean))];
                // ìµœëŒ€ 1ê°œ ì¢…ëª©ë§Œ í‘œì‹œí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ìˆ«ìë¡œ
                if (uniqueStocks.length === 1) {
                    // ì¢…ëª©ëª…ì´ ê¸¸ë©´ ìë¥´ê¸°
                    const stockName = uniqueStocks[0];
                    tradeIndicator.textContent = stockName.length > 6 ? stockName.substring(0, 5) + "..." : stockName;
                } else {
                    tradeIndicator.textContent = `${uniqueStocks[0].substring(0, 4)} +${uniqueStocks.length - 1}`;
                }
                dayElement.appendChild(tradeIndicator);
                
                // í´ë¦­ ì´ë²¤íŠ¸
                dayElement.style.cursor = "pointer";
                dayElement.addEventListener("click", () => showDateDetail(dateStr, trades));
            }

            calendarDays.appendChild(dayElement);
        }
    }

    // ë‚ ì§œ ìƒì„¸ ì •ë³´ í‘œì‹œ
    function showDateDetail(dateStr, trades) {
        const modal = document.getElementById("calendar-detail-modal");
        const dateTitle = document.getElementById("calendar-detail-date");
        const content = document.getElementById("calendar-detail-content");
        
        if (!modal || !dateTitle || !content) return;

        // YYYY-MM-DD í˜•ì‹ì„ ë¡œì»¬ ì‹œê°„ëŒ€ë¡œ íŒŒì‹±
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        const dateFormatted = date.toLocaleDateString("ko-KR", { 
            year: "numeric", 
            month: "long", 
            day: "numeric",
            weekday: "long"
        });
        
        dateTitle.textContent = dateFormatted;

        if (trades.length === 0) {
            content.innerHTML = "<p>ì´ ë‚ ì§œì—ëŠ” ë§¤ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        } else {
            let html = `<div style="margin-bottom: 1rem;"><strong>ì´ ${trades.length}ê±´ì˜ ë§¤ë§¤ ë‚´ì—­</strong></div>`;
            trades.forEach(trade => {
                let profit = Number(trade.profit) || 0;
                if (trade.result === "loss" && profit > 0) {
                    profit = -profit;
                }
                const profitClass = profit > 0 ? "profit-positive" : profit < 0 ? "profit-negative" : "";
                const profitText = typeof formatCurrency === "function" ? formatCurrency(profit) : profit.toLocaleString() + "ì›";
                const resultText = trade.result === "win" ? "ìŠ¹" : trade.result === "draw" ? "ë¬´" : trade.result === "loss" ? "íŒ¨" : "-";
                const getPositionText = (pos) => {
                    const positionMap = {
                        "long": "ë¡±",
                        "short": "ìˆ",
                        "swing": "ìŠ¤ìœ™",
                        "scalping": "ìŠ¤ìº˜í•‘",
                        "day": "ë°ì´íŠ¸ë ˆì´ë”©"
                    };
                    return positionMap[pos] || pos || "-";
                };
                const positionText = getPositionText(trade.position);
                
                html += `
                    <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>${escapeHtml(trade.stock || "-")}</strong>
                            <span class="trading-profit ${profitClass}">${profitText}</span>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">
                            <span>${positionText}</span> Â· 
                            <span>${resultText}</span>
                        </div>
                        ${trade.profitReason ? `<div style="margin-top: 0.5rem; font-size: 0.9rem;">ìµì ˆ ì´ìœ : ${escapeHtml(trade.profitReason)}</div>` : ""}
                        ${trade.lossReason ? `<div style="margin-top: 0.5rem; font-size: 0.9rem;">ì†ì ˆ ì´ìœ : ${escapeHtml(trade.lossReason)}</div>` : ""}
                    </div>
                `;
            });
            content.innerHTML = html;
        }

        modal.classList.add("active");
        const sideModal = modal.querySelector(".side-modal");
        if (sideModal) {
            sideModal.classList.add("active");
        }
    }

    function closeCalendarDetail() {
        const modal = document.getElementById("calendar-detail-modal");
        if (modal) {
            modal.classList.remove("active");
            const sideModal = modal.querySelector(".side-modal");
            if (sideModal) {
                sideModal.classList.remove("active");
            }
        }
    }

    function escapeHtml(str) {
        return String(str ?? "").replace(/[&<>"]/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[s]));
    }

    // ì´ì „/ë‹¤ìŒ ì›” ë²„íŠ¼
    document.getElementById("prev-month")?.addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    });

    document.getElementById("next-month")?.addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById("close-calendar-detail")?.addEventListener("click", closeCalendarDetail);
    document.getElementById("calendar-detail-modal")?.addEventListener("click", (e) => {
        if (e.target.id === "calendar-detail-modal") {
            closeCalendarDetail();
        }
    });

    // ì´ˆê¸° ë Œë”ë§
    renderCalendar();
});
</script>
</body>
</html>


